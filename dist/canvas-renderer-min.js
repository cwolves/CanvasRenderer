/*!
 * Canvas Renderer v0.1.0
 *
 * Copyright 2011, Mark Kahn
 *
 * Date: Thu Jul 21 20:28:12 2011 -0700
 */function html2canvas(a,b){this.$=html2canvas.bridge,this.loadCB=b;for(i=0,l=this.initCtr=this.init.length;i<l;i++)this.init[i].call(this,a)}html2canvas.prototype={init:[],doneInit:function(){var a=this;setTimeout(function(){a._doneInit()},1)},_doneInit:function(){--this.initCtr||this.loadCB()},hide:function(){this.canvas.style.display="none";return this},show:function(){this.canvas.style.display="block";return this}},function(a){var b=window.html2canvas.bridge={browser:{IE7:!1,IE8:!1,IE9:!1},createElement:function(b){return a("<"+b+"></"+b+">").get(0)},getElements:function(b){return a(b).get()},camelCase:a.camelCase,noop:function(){},trim:a.trim,extend:a.extend,backgroundImage:function(b){var c=a(b).css("background-image");return!c||c=="none"?"":/\("?(.*?)"?\)/.exec(c)[1]},windowSize:function(){return{width:a(window).width(),height:a(window).height()}},bodySize:function(){return{width:a(document).width(),height:a(document).height()}},documentScroll:function(){var b=a(document.body);return{top:b.scrollTop(),left:b.scrollLeft()}},getBoundingRect:function(b){var c=a(b),d=c.offset();width=c.outerWidth(),height=c.outerHeight(),d.bottom=d.top+height,d.right=d.left+width,d.height=height,d.width=width;return d},unitsToPx:function(a,b,c){if(a!=null){var d=~a.indexOf("%"),a=parseFloat(a);d&&(a=(b||0)*a/100-(c||0)*a/100);return a}},addEvent:function(b,c,d){a(b).bind(c,d)},textContent:function(a){return a.nodeValue||a.innerText},isVisible:function(a){return b.css(a,"display")!="none"&&b.css(a,"visibility")!="hidden"},css:function(b,c){return a(b).css(c)}};jQuery.each("offset width height".split(" "),function(c,d){!d||(b[a.camelCase(d)]=function(b){return a(b)[d]()})})}(jQuery);var imgs={},cbs=[];html2canvas.prototype.sameOrigin=function(a){var b=this.$.createElement("a");b.href=a;return b.host===location.host&&b.protocol===location.protocol},html2canvas.prototype.getImage=function(a){return imgs[a]&&imgs[a].img},html2canvas.prototype.addImage=function(a,b){if(!!this.sameOrigin(a)){if(imgs[a]){imgs[a].loaded?b():imgs[a].cbs.push(b);return}var c=new Image,d=[b],e={img:c,cbs:d,loaded:!1};c.onload=function(){this.loaded=!0;for(var a=0,b=d.length;a<b;a++)d[a]()},c.onerror=function(){e.img=null,c.onload()},c.src=a,c.width&&setTimeout(c.onload,1),imgs[a]=e}},html2canvas.prototype.init.push(function(a){function f(){--d||e.doneInit()}var b=this.$.getElements("img"),c=this.$.getElements("*"),d=1,e=this;for(var g=0,h=b.length;g<h;g++)d++,this.addImage(b[g].src,f);for(var g=0,h=c.length;g<h;g++){var i=this.$.css(c[g],"background-image");if(!i||i=="none")continue;console.log(i),d++,this.addImage(i,f)}f()}),function(a){var b=html2canvas.prototype.console={},c="log trace".split(" ");for(var d=0,e=c.length;d<e;d++)(function(a){b[a]=function(){return console&&console[a]&&console[a].apply(console,arguments)}})(c[d])}(html2canvas.bridge),html2canvas.prototype.NODETYPES={element:1,text:3},html2canvas.prototype.init.push(function(a){a=this.$.extend({top:0,right:0,bottom:0,left:0},a||{});var b=this.$.bodySize();b.height-=a.top+a.bottom,b.width-=a.left+a.right,this.viewport=this.$.documentScroll(),this.viewport.right=this.viewport.left+b.width,this.viewport.bottom=this.viewport.top+b.height,this.canvas=this.$.createElement("canvas "),this.canvas.width=b.width,this.canvas.height=b.height,this.ctx=this.canvas.getContext("2d"),this.ctx.fillStyle="#FFF",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),a.css&&(this.canvas.style.cssText=a.css),this.doneInit()}),html2canvas.prototype.setStrokeColor=function(a){this._strokeColor==a||(this.ctx.strokeStyle=this._strokeColor=a);return this},html2canvas.prototype.setLineWidth=function(a){this._lineWidth==a||(this.ctx.lineWidth=this._lineWidth=0|a);return this},html2canvas.prototype.setFillStyle=function(a){this._fillStyle==a||(this.ctx.fillStyle=this._fillStyle=a);return this},html2canvas.prototype.setFont=function(a){this._font==a||(this.ctx.font=this._font=a);return this},html2canvas.prototype.setTextAlign=function(a){this._textAlign==a||(this.ctx.textAlign=this._textAlign=a);return this},html2canvas.prototype.setTextBaseline=function(a){this._textBaseline==a||(this.ctx.textBaseline=this._textBaseline=a);return this},html2canvas.prototype.setOpacity=function(a){this._globalAlpha==a||(this.ctx.globalAlpha=this._globalAlpha=a);return this},html2canvas.prototype.render=function(a){var b=this.getElementsByZIndex(a);for(var c=0,d=b.length;c<d;c++){var a=b[c],e=this.$.getBoundingRect(a),f=a.nodeType;if(f==this.NODETYPES.element){var g=this.renderBox(a,e,this);switch(a.nodeName){case"IMG":this.renderImage(a,e,{},this);break;case"CANVAS":this.renderCanvas(a,e,{},this)}}else f==this.NODETYPES.text&&this.renderText(a,e,this)}return this},html2canvas.prototype.appendToNode=function(a){a.appendChild(this.canvas)},html2canvas.prototype.drawBoundingBox=function(a,b){var c=this.$.unitsToPx(this.$.css(a,"border-top-width"),b.height),d=this.$.unitsToPx(this.$.css(a,"border-right-width"),b.width),e=this.$.unitsToPx(this.$.css(a,"border-bottom-width"),b.height),f=this.$.unitsToPx(this.$.css(a,"border-left-width"),b.width),g={top:c,right:d,bottom:e,left:f},h=this.$.css(a,"background-color"),i=this.$.css(a,"background-image");this.setOpacity(a.opacity),this.drawFilledRect(b.left,b.top,b.width,b.height,h),c&&this.drawLine(b.left,b.top+c/2,b.right,b.top+c/2,c,this.$.css(a,"border-top-color"),this.$.css(a,"border-top-style")),e&&this.drawLine(b.left,b.bottom-e/2,b.right,b.bottom-e/2,e,this.$.css(a,"border-bottom-color"),this.$.css(a,"border-bottom-style")),f&&this.drawLine(b.left+f/2,b.top,b.left+f/2,b.bottom,f,this.$.css(a,"border-left-color"),this.$.css(a,"border-left-style")),d&&this.drawLine(b.right-d/2,b.top,b.right-d/2,b.bottom,d,this.$.css(a,"border-right-color"),this.$.css(a,"border-right-style")),i&&this.renderBackgroundImage(a,b,g,i);return g},html2canvas.prototype.drawLine=function(a,b,c,d,e,f,g){this.setStrokeColor(f).setLineWidth(e),this.ctx.beginPath();switch(g){case"dashed":this.ctx.dashedLineTo(a,b,c,d,[3*e,3*e]);break;case"dotted":this.ctx.dashedLineTo(a,b,c,d,[e,e]);break;default:this.ctx.moveTo(a,b),this.ctx.lineTo(c,d)}this.ctx.stroke()},html2canvas.prototype.drawFilledRect=function(a,b,c,d,e){this.setFillStyle(e),this.ctx.fillRect(a,b,c,d)},html2canvas.prototype.renderBox=function(a,b){this.drawBoundingBox(a,b)},html2canvas.prototype.renderImage=function(a,b,c){a=this.getImage(a.src),c.width||(c.width=Infinity),c.height||(c.height=Infinity);var d=b.width>c.width?c.width:b.width,e=b.height>c.height?c.height:b.height,f=b.left,g=b.top,h=0,i=0,j=a.width*(d/b.width),k=a.height*(e/b.height);try{this.ctx.drawImage(a,h,i,j,k,f,g,d,e)}catch(l){}},html2canvas.prototype.renderBackgroundImage=function(a,b,c,d){var e=this.getImage(d);if(!!e){var f=this.$.css(a,"background-repeat"),g=this.$.css(a,"background-position").split(" "),h=this.$.css(a,"background-size"),i=h.split(" "),j=f!="no-repeat"&&f!="repeat-y",k=f!="no-repeat"&&f!="repeat-x",l=e.width,m=e.height;bgPositionX=this.$.unitsToPx(g[0],b.width,j?b.width:l),bgPositionY=this.$.unitsToPx(g[1],b.height,k?b.height:m),bgSizeX=this.$.unitsToPx(i[0],b.width),bgSizeY=this.$.unitsToPx(i[1],b.height),x=0,y=0,bgSizeX&&(l=bgSizeX),bgSizeY&&(m=bgSizeY);while(x<b.width){while(y<b.height)this.renderImage(e,{top:y+b.top+c.top+bgPositionY,left:x+b.left+c.left+bgPositionX,width:l,height:m},{width:b.width-x-c.left-c.right,height:b.height-y-c.top-c.bottom}),k?y+=m:y=b.height;y=0,j?x+=l:x=b.width}}},html2canvas.prototype.analyzeFont=function(a,b){var c=a.parentNode,d=this.$.css(c,"font-style"),e=this.$.css(c,"font-variant"),f=this.$.css(c,"font-weight"),g=this.$.css(c,"font-size"),h=this.$.css(c,"font-family"),i=this.$.css(c,"color"),j=this.$.css(c,"text-transform"),k=this.$.css(c,"text-align"),l=this.$.css(c,"vertical-align");this.setFillStyle(i).setFont(d+" "+e+" "+f+" "+g+" "+h).setTextBaseline("bottom");switch(j){case"capitalize":a.nodeValue=a.nodeValue.replace(/(\W|^)(\w)/g,function(a,b,c){return b+c.toUpperCase()});break;case"uppercase":a.nodeValue=a.nodeValue.toUpperCase();break;case"lowercase":a.nodeValue=a.nodeValue.toLowerCase()}},html2canvas.prototype.drawText=function(a,b){var c=document.createRange();c.selectNode(a);var d=a.parentNode,e=parseFloat(this.$.css(d,"letter-spacing"))||0,f=(c+"").split(e?"":/\b/),g=f.length,h=0,i=0,j;while(i<g){while(i<g&&(!f[i]||f[i]==" "))i++,h++;if(i>=g)break;j=f[i].length,c.setStart(a,h),c.setEnd(a,h+j);var b=c.getBoundingClientRect();b&&this.ctx.fillText(f[i],b.left,b.top+b.height),h+=j,i++}},html2canvas.prototype.renderText=function(a,b,c){!/\S/.test(this.$.textContent(a))||(this.analyzeFont(a,b,c),this.drawText(a,b,c))},html2canvas.prototype.getElementsByZIndex=function(a,b){b||(b={});var c=this.$.isVisible(a);if(!c)return[];var d=this.$.css(a,"opacity");d=parseFloat(d==null?1:d)*(b.opacity==null?1:b.opacity),a.opacity=d==null?1:d;if(!a.childNodes.length)return[a];var e=[],f=[],g,h,i,j;f.zIndex=0,f.index=0,e.push(f),f.push(a);for(var k=0,l=a.childNodes,m=l.length;k<m;k++)g=a.childNodes[k],h=this.$.css(g,"z-index"),i=this.nodeStartsStackingContext(g,h,d),i?(e.push(j=[]),j.index=e.length-1,j.zIndex=h||0):j=f,j.push.apply(j,this.getElementsByZIndex(g,{opacity:d}));e.sort(function(a,b){return a.zIndex==b.zIndex?b.index-a.index:a.zIndex-b.zIndex});return e.concat.apply([],e)},html2canvas.prototype.nodeStartsStackingContext=function(a,b,c){var d=this.$.css(a,"position"),e=this.$.browser.IE7,f=this.$.browser.IE8;c==null&&(c=this.$.css(a,"opacity")),b==null&&(b=this.$.css(a,"z-index")||0),b=parseInt(b),c=~-c;return c&&!e&&!f||(d=="relative"||d=="absolute")&&(b||e)},CanvasRenderingContext2D.prototype.dashedLineTo=function(a,b,c,d,e){var f=function(a,b){return a<=b},g=function(a,b){return a>=b},h=function(a,b){return Math.min(a,b)},i=function(a,b){return Math.max(a,b)},j={thereYet:g,cap:h},k={thereYet:g,cap:h};b-d>0&&(k.thereYet=f,k.cap=i),a-c>0&&(j.thereYet=f,j.cap=i),this.moveTo(a,b);var l=a,m=b,n=0,o=!0;while(!j.thereYet(l,c)||!k.thereYet(m,d)){var p=Math.atan2(d-b,c-a),q=e[n];l=j.cap(c,l+Math.cos(p)*q),m=k.cap(d,m+Math.sin(p)*q),o?this.lineTo(l,m):this.moveTo(l,m),n=(n+1)%e.length,o=!o}}